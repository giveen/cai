"""
Impacket tools wrapper for AI agents.
This module provides wrappers for various Impacket tools that can be invoked programmatically.
"""

import json
import subprocess
import logging
from typing import Dict, Any, Optional, List
from cai.tools.common import run_command  # pylint: disable=E0401
from cai.sdk.agents import function_tool

# Configure logging
logger = logging.getLogger(__name__)

def _run_impacket_tool(tool_name: str, args: List[str], timeout: int = 30) -> Dict[str, Any]:
    """
    Execute an Impacket tool with given arguments.
    
    Args:
        tool_name: Name of the impacket tool (e.g., 'impacket-psexec')
        args: List of command line arguments
        timeout: Timeout in seconds
        
    Returns:
        Dictionary containing result information
    """
    try:
        # Construct full command
        cmd = [tool_name] + args
        
        logger.debug(f"Executing Impacket tool: {' '.join(cmd)}")
        
        # Run the command with timeout
        process = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=timeout,
            check=False  # Don't raise exception on non-zero exit codes
        )
        
        result = {
            "success": process.returncode == 0,
            "tool": tool_name,
            "args": args,
            "return_code": process.returncode,
            "stdout": process.stdout,
            "stderr": process.stderr,
            "command": ' '.join(cmd)
        }
        
        # Try to parse stdout as JSON if possible
        try:
            if process.stdout.strip():
                parsed_output = json.loads(process.stdout.strip())
                result["parsed_output"] = parsed_output
        except json.JSONDecodeError:
            pass
            
        return result
        
    except subprocess.TimeoutExpired:
        logger.error(f"Timeout executing {tool_name}")
        return {
            "success": False,
            "tool": tool_name,
            "error": f"Command timed out after {timeout} seconds",
            "args": args
        }
    except Exception as e:
        logger.error(f"Error running {tool_name}: {str(e)}")
        return {
            "success": False,
            "tool": tool_name,
            "error": str(e),
            "args": args
        }

# Individual Impacket tools following the same pattern as nmap.py

@function_tool
def impacket_psexec(
    target: str, 
    username: str, 
    password: Optional[str] = None,
    domain: Optional[str] = None,
    command: Optional[str] = None,
    timeout: int = 30,
    **kwargs
) -> Dict[str, Any]:
    """
    Execute commands on remote systems using psexec.
    
    Args:
        target: Target host or IP address
        username: Username for authentication
        password: Password for authentication (optional)
        domain: Domain name (optional)
        command: Command to execute (optional)
        timeout: Timeout in seconds
        
    Returns:
        Dictionary with execution results
    """
    args = [target, f"{domain}\\{username}" if domain else username]
    
    if password:
        args.extend(["-password", password])
        
    if command:
        args.extend(["-c", command])
        
    # Add any additional arguments from kwargs
    for key, value in kwargs.items():
        if isinstance(value, bool) and value:
            args.append(f"-{key}")
        elif not isinstance(value, bool):
            args.extend([f"-{key}", str(value)])
    
    return _run_impacket_tool("impacket-psexec", args, timeout)

@function_tool
def impacket_secretsdump(
    target: str,
    username: str,
    password: Optional[str] = None,
    domain: Optional[str] = None,
    timeout: int = 30,
    **kwargs
) -> Dict[str, Any]:
    """
    Dump secrets from a remote system.
    
    Args:
        target: Target host or IP address
        username: Username for authentication
        password: Password for authentication (optional)
        domain: Domain name (optional)
        timeout: Timeout in seconds
        
    Returns:
        Dictionary with execution results
    """
    args = [f"{domain}\\{username}" if domain else username]
    
    if password:
        args.extend(["-password", password])
        
    args.append(target)
    
    # Add any additional arguments from kwargs
    for key, value in kwargs.items():
        if isinstance(value, bool) and value:
            args.append(f"-{key}")
        elif not isinstance(value, bool):
            args.extend([f"-{key}", str(value)])
    
    return _run_impacket_tool("impacket-secretsdump", args, timeout)

@function_tool
def impacket_wmiexec(
    target: str,
    username: str,
    password: Optional[str] = None,
    domain: Optional[str] = None,
    command: Optional[str] = None,
    timeout: int = 30,
    **kwargs
) -> Dict[str, Any]:
    """
    Execute commands on remote systems using WMI.
    
    Args:
        target: Target host or IP address
        username: Username for authentication
        password: Password for authentication (optional)
        domain: Domain name (optional)
        command: Command to execute (optional)
        timeout: Timeout in seconds
        
    Returns:
        Dictionary with execution results
    """
    args = [f"{domain}\\{username}" if domain else username]
    
    if password:
        args.extend(["-password", password])
        
    if command:
        args.append(command)
        
    args.append(target)
    
    # Add any additional arguments from kwargs
    for key, value in kwargs.items():
        if isinstance(value, bool) and value:
            args.append(f"-{key}")
        elif not isinstance(value, bool):
            args.extend([f"-{key}", str(value)])
    
    return _run_impacket_tool("impacket-wmiexec", args, timeout)

@function_tool
def impacket_smbclient(
    target: str,
    username: str,
    password: Optional[str] = None,
    domain: Optional[str] = None,
    command: Optional[str] = None,
    timeout: int = 30,
    **kwargs
) -> Dict[str, Any]:
    """
    Interact with SMB shares on remote systems.
    
    Args:
        target: Target host or IP address
        username: Username for authentication
        password: Password for authentication (optional)
        domain: Domain name (optional)
        command: Command to execute (optional)
        timeout: Timeout in seconds
        
    Returns:
        Dictionary with execution results
    """
    args = [f"{domain}\\{username}" if domain else username]
    
    if password:
        args.extend(["-password", password])
        
    if command:
        args.append(command)
        
    args.append(target)
    
    # Add any additional arguments from kwargs
    for key, value in kwargs.items():
        if isinstance(value, bool) and value:
            args.append(f"-{key}")
        elif not isinstance(value, bool):
            args.extend([f"-{key}", str(value)])
    
    return _run_impacket_tool("impacket-smbclient", args, timeout)

@function_tool
def impacket_getuserspns(
    target: str,
    username: str,
    password: Optional[str] = None,
    domain: Optional[str] = None,
    output_file: Optional[str] = None,
    timeout: int = 30,
    **kwargs
) -> Dict[str, Any]:
    """
    Get user service principal names (SPNs).
    
    Args:
        target: Target host or IP address
        username: Username for authentication
        password: Password for authentication (optional)
        domain: Domain name (optional)
        output_file: Output file path (optional)
        timeout: Timeout in seconds
        
    Returns:
        Dictionary with execution results
    """
    args = [f"{domain}\\{username}" if domain else username]
    
    if password:
        args.extend(["-password", password])
        
    if output_file:
        args.extend(["-outputfile", output_file])
        
    args.append(target)
    
    # Add any additional arguments from kwargs
    for key, value in kwargs.items():
        if isinstance(value, bool) and value:
            args.append(f"-{key}")
        elif not isinstance(value, bool):
            args.extend([f"-{key}", str(value)])
    
    return _run_impacket_tool("impacket-GetUserSPNs", args, timeout)
